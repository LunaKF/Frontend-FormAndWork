<div class="candidatura-page">

  <!-- BANNER ROL ARRIBA -->
  <div class="role-banner" *ngIf="isAdmin">
    <div class="container-xl role-banner-inner">
      <span class="role-chip">
        <i class="bi bi-shield-lock"></i>
        Modo administración activo
      </span>
      <span class="role-text">
        Estás viendo todas las candidaturas de esta oferta. Accede a edición y borrado con cuidado.
      </span>
    </div>
  </div>

  <!-- HERO (MUY “OFERTA” + MUY “CANDIDATURAS”) -->
  <section class="candidatura-hero">
    <div class="candidatura-hero-overlay"></div>

    <div class="container-xl candidatura-hero-inner">

      <div class="hero-kicker">
        <span class="kicker-pill">
          <i class="bi bi-people"></i>
          Candidaturas por oferta
        </span>

        <button type="button" class="hero-link" (click)="viewOferta($event)">
          <i class="bi bi-arrow-up-right"></i>
          Ver oferta
        </button>
      </div>

      <h1 class="candidatura-title">
        {{ oOferta?.titulo || 'Oferta' }}
      </h1>

      <p class="candidatura-subtitle">
        {{oOferta?.descripcion }}
      </p>

      <div class="hero-meta">
        <span class="meta-pill" *ngIf="oOferta?.empresa?.nombre">
          <i class="bi bi-building"></i>
          {{ oOferta?.empresa?.nombre }}
        </span>

        <span class="meta-pill" *ngIf="oOferta?.sector?.nombre">
          <i class="bi bi-diagram-3"></i>
          {{ oOferta?.sector?.nombre }}
        </span>

      </div>

    </div>
  </section>

  <!-- TOOLBAR (calcado del plist de candidaturas) -->
  <section class="candidatura-toolbar" *ngIf="isAdmin || isEmpresa">
    <div class="container-xl">
      <div class="toolbar-card">

        <div class="toolbar-left">
          <div class="searchbox">
            <i class="bi bi-search"></i>
            <input type="text"
              class="form-control"
              placeholder="Buscar por alumno, fecha o ID…"
              [(ngModel)]="strFiltro"
              (ngModelChange)="onFilterChange($event)"
              aria-label="Buscar candidaturas" />
          </div>

          <div class="chips">
            <span class="chip" [class.chip-muted]="filterLen === 0">
              <i class="bi bi-funnel"></i>
              @if (filterLen > 0) { Filtro: <strong>{{ strFiltro }}</strong> } @else { Sin filtro activo }
            </span>

            <span class="chip">
              <i class="bi bi-collection"></i>
              {{ displayedCount }} de {{ totalCount }} candidaturas
            </span>
          </div>
        </div>

        <div class="toolbar-right">
          <div class="rpp-pills" aria-label="Resultados por página">
            <button type="button" class="pill-rpp" [class.active]="nRpp === 12" (click)="goToRpp(12)">12</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 24" (click)="goToRpp(24)">24</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 36" (click)="goToRpp(36)">36</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="candidatura-grid" *ngIf="isAdmin || isEmpresa">
    <div class="container-xl">

      <!-- Skeleton -->
      <ng-container *ngIf="loading">
        <article class="cand-rowcard skeleton" *ngFor="let i of [1,2,3,4,5,6]">
          <div class="sk-line"></div>
          <div class="sk-line short"></div>
        </article>
      </ng-container>

      <!-- Lista cards alargadas -->
      <div class="cand-list" *ngIf="!loading">

        <article class="cand-rowcard"
          *ngFor="let c of displayedCards"
          tabindex="0"
          (click)="view(c)"
          (keydown.enter)="view(c)"
          (keydown.space)="$event.preventDefault(); view(c)"
        >
          <div class="row-left">
            <div class="row-avatar" aria-hidden="true">
              <span>{{ (alumnoNombre(c) || 'AL').slice(0,2).toUpperCase() }}</span>
            </div>

            <div class="row-info">
              <div class="row-topline">
                <span class="row-name">{{ alumnoNombre(c) }}</span>

                <!-- ID candidatura: SOLO admin -->
                <span class="row-id" *ngIf="canSeeIds">
                  <i class="bi bi-hash"></i> {{ c.id }}
                </span>
              </div>

              <div class="row-meta">
                <span class="meta-chip">
                  <i class="bi bi-calendar3"></i>
                  {{ c.fecha || '—' }}
                </span>

                <!-- ID oferta solo admin (si quieres) -->
                <span class="meta-chip soft" *ngIf="canSeeIds">
                  <i class="bi bi-briefcase"></i>
                  Oferta #{{ oOferta?.id }}
                </span>
              </div>
            </div>
          </div>

          <div class="row-actions">
            <button type="button" class="iconbtn" (click)="$event.stopPropagation(); view(c)" aria-label="Ver">
              <i class="bi bi-eye"></i>
            </button>

            <button *ngIf="canManage" type="button" class="iconbtn" (click)="$event.stopPropagation(); edit(c)" aria-label="Editar">
              <i class="bi bi-pen"></i>
            </button>

            <button *ngIf="canManage" type="button" class="iconbtn danger" (click)="$event.stopPropagation(); remove(c)" aria-label="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </div>

          <div class="row-underline" aria-hidden="true"></div>
        </article>

        <!-- Vacío -->
        <div class="empty" *ngIf="displayedCards.length === 0">
          <i class="bi bi-emoji-neutral"></i>
          <p>No hay candidaturas que coincidan con la búsqueda.</p>
        </div>

      </div>

      <!-- Paginación -->
      <nav class="my-3" aria-label="Paginación" *ngIf="hasMultiplePages() && !loading">
        <ul class="pagination justify-content-center flex-wrap">

          <li class="page-item" [class.disabled]="(nPage + 1) === 1">
            <a class="page-link" href="#" (click)="$event.preventDefault(); goToPrev()" aria-label="Página anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li class="page-item" *ngFor="let pag of arrBotonera">
            @if (pag === '...') {
              <span class="page-link dots" aria-hidden="true">…</span>
            } @else {
              <a class="page-link"
                 href="#"
                 (click)="$event.preventDefault(); goToPage(+pag)"
                 [class.active]="(nPage + 1) === +pag">
                {{ pag }}
              </a>
            }
          </li>

          <li class="page-item" [class.disabled]="(nPage + 1) === (oPage?.totalPages || 0)">
            <a class="page-link" href="#" (click)="$event.preventDefault(); goToNext()" aria-label="Página siguiente">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>

        </ul>
      </nav>

    </div>
  </section>

  <!-- Si no eres admin/empresa -->
  <section class="candidatura-grid" *ngIf="!(isAdmin || isEmpresa)">
    <div class="container-xl">
      <div class="empty">
        <i class="bi bi-shield-lock"></i>
        <p>No tienes permisos para ver esta página.</p>
      </div>
    </div>
  </section>

</div>
