<div class="page soft-bg">
  <!-- Header -->
  <header class="header-ofertas">
    <div class="container-xl">
      <div class="toolbar">
        <div class="title-group">
          <h1 class="title-gradient">Candidaturas</h1>

          <p class="subtitle" *ngIf="isEmpresa && !isAdmin">
            Vista de empresa: candidaturas agrupadas por <strong>oferta</strong>.
          </p>
          <p class="subtitle" *ngIf="isAlumno && !isAdmin">
            Vista de alumno: se muestran <strong>solo tus candidaturas</strong>.
          </p>
          <p class="subtitle" *ngIf="isAdmin">
            Vista de administrador: acceso completo.
          </p>
        </div>

        <div class="tools">
          <div class="searchbox">
            <i class="bi bi-search"></i>
            <!-- IMPORTANTE: usamos ngModelChange (no keyup) para debouncing real -->
            <input
              type="text"
              class="form-control"
              placeholder="Buscar por oferta o alumno…"
              [(ngModel)]="strFiltro"
              (ngModelChange)="onFilterChange($event)"
              aria-label="Buscar candidaturas"
            />
          </div>

          <div class="btn-group rpp-pills" role="group" aria-label="Resultados por página">
            <button type="button" class="btn" [class.active]="nRpp === 10" (click)="goToRpp(10)">10</button>
            <button type="button" class="btn" [class.active]="nRpp === 50" (click)="goToRpp(50)">50</button>
            <button type="button" class="btn" [class.active]="nRpp === 100" (click)="goToRpp(100)">100</button>
          </div>
        </div>

        <!-- Chips estado -->
        <div class="chips">
          <span class="chip" [class.chip-muted]="filterLen === 0">
            <i class="bi bi-funnel"></i>
            @if (filterLen > 0) {
              Filtro: <strong class="text-danger">{{ strFiltro }}</strong>
            } @else {
              Sin filtro
            }
          </span>

          <span class="chip">
            <i class="bi bi-collection"></i>
            Mostrando {{ displayedCount | number:'1.0-0' }}
            de {{ totalCount | number:'1.0-0' }}
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido -->
  <section class="content">
    <div class="container-xl">

      <!-- Skeleton -->
      <div *ngIf="loading" class="card shadow-xl rounded-4 overflow-hidden p-4">
        <div class="sk-line"></div>
        <div class="sk-line"></div>
        <div class="sk-line short"></div>
      </div>

      <!-- EMPRESA (no admin): bloques agrupados por oferta -->
      <ng-container *ngIf="!loading && isEmpresa && !isAdmin">
        <div class="group-list">
          <article class="group-card hover-rise" *ngFor="let g of groupsByOferta">
            <header class="group-header">
              <div class="left">
                <h2 class="group-title">
                  <span *ngIf="isAdmin" class="badge-id">#{{ g.ofertaId }}</span>
                  <span class="title">{{ g.ofertaTitulo || ('Oferta ' + g.ofertaId) }}</span>
                </h2>
              </div>
              <div class="right">
                <a class="btn btn-light lift" [routerLink]="['/admin','oferta','view', g.ofertaId]">
                  <i class="bi bi-eye"></i> Ver oferta
                </a>
              </div>
            </header>

            <ul class="cand-list">
              <li class="cand-item" *ngFor="let c of g.items">
                <div class="col-id" *ngIf="isAdmin">#{{ c.id }}</div>
                <div class="col-main">
                  <div class="name">{{ c.alumno?.nombre }} {{ c.alumno?.ape1 }} {{ c.alumno?.ape2 }}</div>
                  <div class="meta small text-muted">Fecha: {{ c.fecha }}</div>
                </div>
                <div class="col-actions">
                  <button type="button" class="btn-icon lift" (click)="view(c)" aria-label="Ver"><i class="bi bi-eye"></i></button>
                  <button *ngIf="isAdmin" type="button" class="btn-icon lift" (click)="edit(c)" aria-label="Editar"><i class="bi bi-pen"></i></button>
                  <button *ngIf="isAdmin || isAlumno" type="button" class="btn-icon lift btn-danger-soft" (click)="remove(c)" aria-label="Eliminar"><i class="bi bi-trash"></i></button>
                </div>
              </li>
            </ul>
          </article>

          <div class="empty" *ngIf="groupsByOferta.length===0">
            <i class="bi bi-emoji-neutral"></i>
            <p>No hay candidaturas para mostrar.</p>
          </div>
        </div>
      </ng-container>

      <!-- ADMIN o ALUMNO: tabla clásica -->
      <ng-container *ngIf="!loading && (!isEmpresa || isAdmin)">
        <div class="card shadow-xl rounded-4 overflow-hidden">
          <div class="table-wrapper p-4">
            <div class="table-responsive">
              <table class="table table-separated align-middle text-center table-cands mb-0">
                <thead class="table-header">
                  <tr>
                    <th *ngIf="isAdmin" class="min-col">ID</th>
                    <th>Fecha</th>
                    <th>Oferta</th>
                    <th *ngIf="isAdmin">Alumno</th>
                    <th class="min-col">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  @for (c of displayedRows; track c.id) {
                    <tr class="row-card hover-rise">
                      <td *ngIf="isAdmin" class="idContent">{{ c.id }}</td>
                      <td>{{ c.fecha }}</td>
                      <td class="text-start">
                        <a [routerLink]="['/admin','oferta','view', c.oferta?.id]" class="link-empresa">
                          {{ c.oferta?.titulo || ('Oferta ' + c.oferta?.id) }}
                        </a>
                      </td>
                      <td *ngIf="isAdmin" class="text-start">
                        {{ c.alumno?.nombre }} {{ c.alumno?.ape1 }} {{ c.alumno?.ape2 }}
                      </td>
                      <td>
                        <div class="d-flex gap-2 justify-content-center">
                          <button type="button" class="btn-icon lift" (click)="view(c)" aria-label="Ver"><i class="bi bi-eye"></i></button>
                          <button *ngIf="isAdmin" type="button" class="btn-icon lift" (click)="edit(c)" aria-label="Editar"><i class="bi bi-pen"></i></button>
                          <button *ngIf="isAdmin || isAlumno" type="button" class="btn-icon lift btn-danger-soft" (click)="remove(c)" aria-label="Eliminar"><i class="bi bi-trash"></i></button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td [attr.colspan]="isAdmin ? 5 : 4" class="text-center py-5 text-muted">No hay candidaturas</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            <nav class="my-3" aria-label="Paginación" *ngIf="hasMultiplePages()">
              <ul class="pagination justify-content-center flex-wrap gap-1">
                <li class="page-item" [class.disabled]="(nPage + 1) === 1">
                  <a class="page-link" href="#" (click)="goToPrev()"><i class="bi bi-caret-left-square-fill"></i></a>
                </li>

                <li class="page-item" *ngFor="let pag of arrBotonera">
                  @if (pag === '...') {
                    <span class="page-link">{{ pag }}</span>
                  } @else {
                    <a class="page-link" href="#" (click)="goToPage(+pag)" [class.active]="(nPage + 1) === +pag">{{ pag }}</a>
                  }
                </li>

                <li class="page-item" [class.disabled]="(nPage + 1) === (oPage?.totalPages || 0)">
                  <a class="page-link" href="#" (click)="goToNext()"><i class="bi bi-caret-right-square-fill"></i></a>
                </li>
              </ul>
            </nav>

          </div>
        </div>
      </ng-container>

    </div>
  </section>
</div>
