<div class="candidatura-page">

  <!-- BANNER ROL ARRIBA DEL TODO (igual que empresas) -->
  <div class="role-banner" *ngIf="isAdmin">
    <div class="container-xl role-banner-inner">
      <span class="role-chip">
        <i class="bi bi-shield-lock"></i>
        Modo administración activo
      </span>
      <span class="role-text">
        Estás viendo la vista completa de candidaturas. Accede a edición y borrado con cuidado.
      </span>
    </div>
  </div>

  <!-- HERO (igual que empresas) -->
  <section class="candidatura-hero">
    <div class="candidatura-hero-overlay"></div>

    <div class="container-xl candidatura-hero-inner">
      <h1 class="candidatura-title">Candidaturas</h1>

      <p class="candidatura-subtitle">
        Descubre el tejido empresarial que colabora con centros y alumnado
        en FormAndWork. Esta sección está disponible para administración y estudiantes.
      </p>

    </div>
  </section>

  <!-- TOOLBAR (igual que empresas) -->
  <section class="candidatura-toolbar">
    <div class="container-xl">
      <div class="toolbar-card">

        <div class="toolbar-left">
          <div class="searchbox">
            <i class="bi bi-search"></i>
            <input type="text" class="form-control" placeholder="Buscar por oferta, alumno, fecha, ID…"
              [(ngModel)]="strFiltro" (ngModelChange)="onFilterChange($event)" aria-label="Buscar candidaturas" />
          </div>

          <div class="chips">
            <span class="chip" [class.chip-muted]="filterLen === 0">
              <i class="bi bi-funnel"></i>
              @if (filterLen > 0) {
              Filtro: <strong>{{ strFiltro }}</strong>
              } @else {
              Sin filtro activo
              }
            </span>

            <span class="chip">
              <i class="bi bi-collection"></i>
              {{ displayedCount }} de {{ totalCount }} candidaturas
            </span>
          </div>
        </div>

        <div class="toolbar-right">
          <div class="rpp-pills" aria-label="Resultados por página">
            <button type="button" class="pill-rpp" [class.active]="nRpp === 12" (click)="goToRpp(12)">12</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 24" (click)="goToRpp(24)">24</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 36" (click)="goToRpp(36)">36</button>

          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="candidatura-grid">
    <div class="container-xl">

      <!-- Skeleton -->
      <ng-container *ngIf="loading">
        <article class="cand-card skeleton" *ngFor="let i of [1,2,3,4,5,6]">
          <div class="cand-top">
            <div class="sk-badge"></div>
            <div class="sk-line"></div>
          </div>
          <div class="sk-line short"></div>
          <div class="sk-line"></div>
        </article>
      </ng-container>

      <!-- EMPRESA: agrupadas por oferta -->
      <ng-container *ngIf="!loading && isEmpresa && !isAdmin">

        <div class="offer-groups">

          <article class="offer-group" *ngFor="let g of groupsByOferta">
            <header class="offer-head" (click)="viewOferta(g.ofertaId)">
              <div class="offer-left">
                <div class="offer-badge">
                  <i class="bi bi-briefcase"></i>
                  Oferta #{{ g.ofertaId }}
                </div>
                <h2 class="offer-title">{{ g.ofertaTitulo || ('Oferta ' + g.ofertaId) }}</h2>
                <div class="offer-meta">
                  <span class="meta-pill">
                    <i class="bi bi-people"></i>
                    {{ g.items.length }} candidaturas
                  </span>
                </div>
              </div>

              <button class="offer-cta" type="button" (click)="viewOferta(g.ofertaId, $event)">
                <i class="bi bi-eye"></i>
                Ver oferta
              </button>
            </header>

            <div class="offer-body">
              <article class="cand-mini" *ngFor="let c of g.items" tabindex="0" (click)="view(c)"
                (keydown.enter)="view(c)">
                <div class="mini-left">
                  <div class="mini-avatar">
                    <span>{{ alumnoNombre(c).slice(0,2).toUpperCase() }}</span>
                  </div>

                  <div class="mini-info">
                    <div class="mini-name">{{ alumnoNombre(c) }}</div>
                  </div>
                </div>

                <div class="mini-actions">
                  <button class="iconbtn" type="button" (click)="$event.stopPropagation(); view(c)">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button *ngIf="isAdmin" class="iconbtn" type="button" (click)="$event.stopPropagation(); edit(c)">
                    <i class="bi bi-pen"></i>
                  </button>
                  <button *ngIf="isAdmin || isAlumno" class="iconbtn danger" type="button"
                    (click)="$event.stopPropagation(); remove(c)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </article>
            </div>
          </article>

          <div class="empty" *ngIf="groupsByOferta.length === 0">
            <i class="bi bi-emoji-neutral"></i>
            <p>No hay candidaturas para mostrar.</p>
          </div>
        </div>
      </ng-container>

      <!-- ADMIN / ALUMNO: GRID de cards -->
      <ng-container *ngIf="!loading && (!isEmpresa || isAdmin)">

        <div class="grid">
          <article class="cand-card" *ngFor="let c of displayedCards" tabindex="0" (click)="view(c)"
            (keydown.enter)="view(c)">
            <div class="cand-glow"></div>

            <div class="cand-top">
              <div class="cand-badges">
                <span class="badge badge-violet" *ngIf="isAdmin">
                  <i class="bi bi-hash"></i> {{ c.id }}
                </span>
              </div>

              <button class="pill-link" type="button" (click)="viewOferta(c.oferta?.id || 0, $event)">
                <i class="bi bi-briefcase"></i>
                Oferta
                <i class="bi bi-arrow-up-right"></i>
              </button>
            </div>

            <h2 class="cand-title">{{ ofertaTitulo(c) }}</h2>

            <div class="cand-row" *ngIf="isAdmin">
              <span class="label"><i class="bi bi-person-badge"></i> Alumno</span>
              <span class="value">{{ alumnoNombre(c) }}</span>
            </div>

            <div class="cand-row" *ngIf="!isAdmin">
              <span class="label"><i class="bi bi-info-circle"></i> Estado</span>
              <span class="value">Registrada</span>
            </div>

            <div class="cand-actions">
              <button class="btn" type="button" (click)="$event.stopPropagation(); view(c)">
                <i class="bi bi-eye"></i> Ver
              </button>

              <button *ngIf="isAdmin" class="btn" type="button" (click)="$event.stopPropagation(); edit(c)">
                <i class="bi bi-pen"></i> Editar
              </button>

              <button *ngIf="isAdmin || isAlumno" class="btn danger" type="button"
                (click)="$event.stopPropagation(); remove(c)">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </article>

          <div class="empty" *ngIf="displayedCards.length === 0">
            <i class="bi bi-emoji-neutral"></i>
            <p>No hay candidaturas que coincidan con la búsqueda.</p>
          </div>
        </div>
      </ng-container>

      <!-- Paginación (igual que empresas) -->
      <nav class="my-3" aria-label="Paginación" *ngIf="hasMultiplePages() && !loading">
        <ul class="pagination justify-content-center flex-wrap">

          <li class="page-item" [class.disabled]="(nPage + 1) === 1">
            <a class="page-link" href="#" (click)="goToPrev()" aria-label="Página anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li class="page-item" *ngFor="let pag of arrBotonera">
            @if (pag === '...') {
            <span class="page-link dots" aria-hidden="true">…</span>
            } @else {
            <a class="page-link" href="#" (click)="goToPage(+pag)" [class.active]="(nPage + 1) === +pag">
              {{ pag }}
            </a>
            }
          </li>

          <li class="page-item" [class.disabled]="(nPage + 1) === (oPage?.totalPages || 0)">
            <a class="page-link" href="#" (click)="goToNext()" aria-label="Página siguiente">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>

        </ul>
      </nav>

    </div>
  </section>
</div>