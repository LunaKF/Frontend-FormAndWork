<div class="empresa-page">

  <!-- BANNER ROL ARRIBA -->
  <div class="role-banner" *ngIf="isAdmin">
    <div class="container-xl role-banner-inner">
      <span class="role-chip">
        <i class="bi bi-shield-lock"></i>
        Modo administración activo
      </span>
      <span class="role-text">
        Gestión completa de ofertas del sector: crea, edita, elimina y revisa candidaturas.
      </span>
    </div>
  </div>

  <!-- HERO -->
  <section class="empresa-hero">
    <div class="empresa-hero-overlay"></div>

    <!-- (los blobs están “apagados” en CSS si quieres 1:1 con empresas) -->
    <div class="hero-blobs" aria-hidden="true">
      <span class="blob b1"></span>
      <span class="blob b2"></span>
      <span class="blob b3"></span>
    </div>

    <div class="container-xl empresa-hero-inner">
      <h1 class="empresa-title">
        Ofertas del sector {{ oSector?.nombre || 'Sector' }}
      </h1>

      <p class="empresa-subtitle">
        Explora las ofertas disponibles en este sector.
        @if (!activeSession) {
        <strong> Inicia sesión para ver los detalles.</strong>
        }
      </p>

      <div class="empresa-roles">
        <span class="role-pill soft" *ngIf="isAlumno">
          <i class="bi bi-mortarboard"></i>
          Vista para alumnado
        </span>

        <span class="role-pill soft" *ngIf="isEmpresa">
          <i class="bi bi-building"></i>
          Vista para empresa
        </span>
      </div>
    </div>
  </section>

  <!-- TOOLBAR -->
  <section class="empresa-toolbar">
    <div class="container-xl">
      <div class="toolbar-card">
        <div class="toolbar-left">
          <div class="searchbox">
            <i class="bi bi-search"></i>
            <input type="text" class="form-control" placeholder="Buscar por título, descripción, sector o empresa…"
              [(ngModel)]="strFiltro" (input)="filter()" aria-label="Buscar ofertas" />
          </div>

          <div class="chips">
            <span class="chip" [class.chip-muted]="!(strFiltro.length>0)">
              <i class="bi bi-funnel"></i>
              @if (strFiltro.length>0) {
              Filtro: <strong>{{ strFiltro }}</strong>
              } @else {
              Sin filtro activo
              }
            </span>

            <span class="chip" *ngIf="oPage">
              <i class="bi bi-collection"></i>
              {{ filteredOfertas.length }}
              de {{ oPage.totalElements || 0 | number:'1.0-0' }}
            </span>
          </div>
        </div>

        <div class="toolbar-right">
          <div class="rpp-pills" aria-label="Resultados por página">
            <button type="button" class="pill-rpp" [class.active]="nRpp === 10" (click)="goToRpp(10)">10</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 20" (click)="goToRpp(20)">20</button>
            <button type="button" class="pill-rpp" [class.active]="nRpp === 30" (click)="goToRpp(30)">30</button>
          </div>

          <button *ngIf="canManageOferta" type="button" class="btn-cta" (click)="create()">
            <span class="btn-cta-bg"></span>
            <span class="btn-cta-label">
              <i class="bi bi-plus-lg"></i>
              Nueva oferta
            </span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- LISTA -->
  <section class="empresa-grid">
    <div class="container-xl">

      <!-- Skeleton -->
      <ng-container *ngIf="loading">
        <article class="offer-card skeleton" *ngFor="let i of [1,2,3,4,5,6]">
          <div class="offer-top">
            <div class="offer-avatar sk"></div>
            <div class="offer-main">
              <div class="sk-line"></div>
              <div class="sk-line short"></div>
            </div>
          </div>
        </article>
      </ng-container>

      <!-- Cards -->
      <div class="offer-list" *ngIf="!loading">
        <article class="offer-card" *ngFor="let oferta of filteredOfertas; trackBy: trackById"
          [class.clickable]="canOpenView" tabindex="0" (click)="onCardClick(oferta)"
          (keydown.enter)="onCardClick(oferta)" (keydown.space)="$event.preventDefault(); onCardClick(oferta)"
          [attr.aria-label]="canOpenView ? ('Abrir oferta ' + (oferta?.titulo || '')) : 'Inicia sesión para ver detalles'"
          [title]="canOpenView ? ('Ver ' + (oferta?.titulo || '')) : 'Inicia sesión para ver los detalles'">
          <div class="offer-top">
            <div class="offer-avatar" aria-hidden="true">
              <i class="bi bi-briefcase"></i>
            </div>

            <div class="offer-main">
              <div class="offer-head">
                <h2 class="offer-title">{{ oferta.titulo | trim: 60 }}</h2>

                <div class="offer-tags">
                  <span class="tag">
                    <i class="bi bi-diagram-3"></i>
                    {{ oferta.sector?.nombre || 'Sector' }}
                  </span>

                  <!-- Empresa: SOLO si NO es empresa -->
                  <span class="tag soft" *ngIf="!isEmpresa">
                    <i class="bi bi-building"></i>
                    {{ oferta.empresa?.nombre || 'Empresa' }}
                  </span>
                </div>
              </div>

              <p class="offer-desc">
                {{ excerpt(oferta.descripcion, 165) }}
              </p>
            </div>

            <div class="offer-side">
              <!-- Candidaturas: SOLO admin/empresa -->
              <button *ngIf="canSeeCandidaturas" type="button" class="pill-action"
                (click)="candidaturas(oferta, $event)" [class.disabled]="!(getCandidaturasCount(oferta) > 0)"
                [attr.aria-label]="'Ver candidaturas de ' + (oferta?.titulo || '')">
                <i class="bi bi-people"></i>
                <span class="pill-label">Candidaturas</span>
                <span class="pill-count">{{ getCandidaturasCount(oferta) }}</span>
              </button>

              <!-- Acciones -->
              <div class="offer-actions" *ngIf="canManageOferta">
                <button type="button" class="btn-mini" (click)="$event.stopPropagation(); edit(oferta)">
                  <i class="bi bi-pen"></i> Editar
                </button>
                <button type="button" class="btn-mini danger" (click)="$event.stopPropagation(); remove(oferta)">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>

          <div class="offer-underline" aria-hidden="true"></div>
        </article>

        <!-- Vacío -->
        <div class="empty" *ngIf="filteredOfertas.length === 0">
          <i class="bi bi-emoji-neutral"></i>
          <p>No hay ofertas que coincidan.</p>
        </div>
      </div>

      <!-- Paginación -->
      <nav class="my-3" aria-label="Paginación" *ngIf="hasMultiplePages()">
        <ul class="pagination justify-content-center flex-wrap">
          <li class="page-item" [class.disabled]="!hasPrev()">
            <a class="page-link" href="#" (click)="$event.preventDefault(); goToPrev()" aria-label="Página anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li class="page-item" *ngFor="let pag of arrBotonera">
            @if (pag === '...') {
            <span class="page-link dots" aria-hidden="true">…</span>
            } @else {
            <a class="page-link" href="#" (click)="$event.preventDefault(); goToPage(+pag)"
              [class.active]="currentPage === +pag">
              {{ pag }}
            </a>
            }
          </li>

          <li class="page-item" [class.disabled]="!hasNext()">
            <a class="page-link" href="#" (click)="$event.preventDefault(); goToNext()" aria-label="Página siguiente">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>

    </div>
  </section>

</div>